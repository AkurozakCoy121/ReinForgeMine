<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RURFALEWTYUME | RCMT - JSON Article Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: #f0f0f0;
        }
        .terminal-header {
            background-color: #1a1a1a;
            border-bottom: 2px solid #00ff00;
        }
        .main-container {
            border: 1px solid #00ff00;
            background-color: #1a1a1a;
        }
        input, textarea {
            border: 1px solid #00ff00 !important;
            background-color: #000000;
            color: #00ff00;
            padding: 8px 12px;
        }
        button {
            transition: background-color 0.15s, transform 0.15s;
        }
        .btn-primary {
            background-color: #008000;
            color: white;
            border-color: #008000 !important;
        }
        .btn-primary:hover {
            background-color: #00b300;
        }
        .btn-success {
            background-color: #00ff00;
            color: black;
            font-weight: bold;
            border-color: #00ff00 !important;
        }
        .btn-success:hover {
            background-color: #00e600;
            transform: scale(1.02);
        }
        .editor-toolbar {
            background-color: #2a2a2a;
            border: 1px solid #00ff00;
            padding: 8px;
            border-radius: 4px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .editor-button {
            background-color: #333;
            border: 1px solid #555;
            color: #00ff00;
            padding: 6px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .editor-button:hover {
            background-color: #444;
        }
        .editor-dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #333;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border: 1px solid #00ff00;
        }
        .dropdown-content button {
            color: #00ff00;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            background: #333;
            border: none;
        }
        .dropdown-content button:hover {
            background-color: #444;
        }
        .editor-dropdown:hover .dropdown-content {
            display: block;
        }
        .upload-tabs {
            display: flex;
            border-bottom: 1px solid #00ff00;
            margin-bottom: 10px;
        }
        .upload-tab {
            padding: 8px 16px;
            cursor: pointer;
            border: 1px solid transparent;
            margin-right: 5px;
        }
        .upload-tab.active {
            background-color: #008000;
            border-color: #00ff00;
        }
        .upload-content {
            display: none;
        }
        .upload-content.active {
            display: block;
        }
        #description {
            min-height: 400px;
            background: white;
            color: black;
            border: 1px solid #ccc;
            padding: 12px;
            border-radius: 4px;
        }
        .color-picker {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            padding: 8px;
        }
        .color-option {
            width: 20px;
            height: 20px;
            border: 1px solid #fff;
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen p-4" onload="initApp()">

    <!-- Main Application Container -->
    <div id="app-container" class="max-w-5xl mx-auto p-6 space-y-6 main-container">

        <header class="terminal-header p-4 mb-6">
            <h1 class="text-3xl font-bold text-[#00ff00]">RURFALEWTYUME <span class="text-xl">| RCMT</span></h1>
            <p class="text-sm text-gray-400">ReinForge Content Management Terminal - JSON Export Mode</p>
        </header>

        <!-- Status Message and User ID Display -->
        <div class="flex justify-between items-center text-xs text-gray-500">
            <p id="status-message" class="text-red-400"></p>
            <p id="local-status">Status: Local Data Mode</p>
        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="space-y-4">
            <h2 class="text-xl font-semibold text-white">ACCESS REQUIRED</h2>
            <input type="password" id="access-token" placeholder="Enter RF Access Token" class="w-full">
            <button onclick="handleLogin()" class="w-full btn-success">Login to RCMT</button>
            <p class="text-sm text-yellow-400">Checking against khamu.json token...</p>
        </div>

        <!-- Article Upload & Export Screen -->
        <div id="upload-screen" class="hidden space-y-6">
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column: Form -->
                <div class="lg:col-span-2 space-y-4">
                    <h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-2">Article Data Input</h2>

                    <form id="article-form" class="space-y-4">
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-400">Title</label>
                            <input type="text" id="title" required class="w-full mt-1">
                        </div>
                        
                        <div>
                            <label for="slug" class="block text-sm font-medium text-gray-400">Slug (URL-friendly)</label>
                            <input type="text" id="slug" required class="w-full mt-1">
                            <p class="text-xs text-gray-500 mt-1">Example: exploring-the-new-mob</p>
                        </div>

                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-400">Description / Article Content</label>
                            
                            <!-- WYSIWYG Rich Text Editor Toolbar -->
                            <div class="editor-toolbar mb-2">
                                <!-- Font Styles -->
                                <div class="editor-dropdown">
                                    <button type="button" class="editor-button">Format ‚ñº</button>
                                    <div class="dropdown-content">
                                        <button type="button" onclick="formatText('formatBlock', 'h1')">Heading 1</button>
                                        <button type="button" onclick="formatText('formatBlock', 'h2')">Heading 2</button>
                                        <button type="button" onclick="formatText('formatBlock', 'h3')">Heading 3</button>
                                        <button type="button" onclick="formatText('formatBlock', 'h4')">Heading 4</button>
                                        <button type="button" onclick="formatText('formatBlock', 'h5')">Heading 5</button>
                                        <button type="button" onclick="formatText('formatBlock', 'h6')">Heading 6</button>
                                        <button type="button" onclick="formatText('formatBlock', 'p')">Paragraph</button>
                                        <button type="button" onclick="formatText('formatBlock', 'blockquote')">Blockquote</button>
                                    </div>
                                </div>

                                <!-- Text Formatting -->
                                <button type="button" class="editor-button" onclick="formatText('bold')" title="Bold"><b>B</b></button>
                                <button type="button" class="editor-button" onclick="formatText('italic')" title="Italic"><i>I</i></button>
                                <button type="button" class="editor-button" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                                <button type="button" class="editor-button" onclick="formatText('strikeThrough')" title="Strikethrough"><s>S</s></button>

                                <!-- Font Family -->
                                <div class="editor-dropdown">
                                    <button type="button" class="editor-button">Font ‚ñº</button>
                                    <div class="dropdown-content">
                                        <button type="button" onclick="formatText('fontName', 'Arial')">Arial</button>
                                        <button type="button" onclick="formatText('fontName', 'Georgia')">Georgia</button>
                                        <button type="button" onclick="formatText('fontName', 'Courier New')">Courier New</button>
                                        <button type="button" onclick="formatText('fontName', 'Times New Roman')">Times New Roman</button>
                                        <button type="button" onclick="formatText('fontName', 'Verdana')">Verdana</button>
                                        <button type="button" onclick="formatText('fontName', 'Impact')">Impact</button>
                                    </div>
                                </div>

                                <!-- Font Size -->
                                <div class="editor-dropdown">
                                    <button type="button" class="editor-button">Size ‚ñº</button>
                                    <div class="dropdown-content">
                                        <button type="button" onclick="formatText('fontSize', '1')">Small</button>
                                        <button type="button" onclick="formatText('fontSize', '3')">Normal</button>
                                        <button type="button" onclick="formatText('fontSize', '5')">Large</button>
                                        <button type="button" onclick="formatText('fontSize', '7')">X-Large</button>
                                    </div>
                                </div>

                                <!-- Text Color -->
                                <div class="editor-dropdown">
                                    <button type="button" class="editor-button">Color ‚ñº</button>
                                    <div class="dropdown-content">
                                        <div class="color-picker">
                                            <div class="color-option" style="background-color: #000000;" onclick="formatText('foreColor', '#000000')"></div>
                                            <div class="color-option" style="background-color: #FF0000;" onclick="formatText('foreColor', '#FF0000')"></div>
                                            <div class="color-option" style="background-color: #00FF00;" onclick="formatText('foreColor', '#00FF00')"></div>
                                            <div class="color-option" style="background-color: #0000FF;" onclick="formatText('foreColor', '#0000FF')"></div>
                                            <div class="color-option" style="background-color: #FFFF00;" onclick="formatText('foreColor', '#FFFF00')"></div>
                                            <div class="color-option" style="background-color: #FF00FF;" onclick="formatText('foreColor', '#FF00FF')"></div>
                                            <div class="color-option" style="background-color: #00FFFF;" onclick="formatText('foreColor', '#00FFFF')"></div>
                                            <div class="color-option" style="background-color: #FFFFFF;" onclick="formatText('foreColor', '#FFFFFF')"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Background Color -->
                                <div class="editor-dropdown">
                                    <button type="button" class="editor-button">BG Color ‚ñº</button>
                                    <div class="dropdown-content">
                                        <div class="color-picker">
                                            <div class="color-option" style="background-color: #FFFF00;" onclick="formatText('hiliteColor', '#FFFF00')"></div>
                                            <div class="color-option" style="background-color: #00FF00;" onclick="formatText('hiliteColor', '#00FF00')"></div>
                                            <div class="color-option" style="background-color: #00FFFF;" onclick="formatText('hiliteColor', '#00FFFF')"></div>
                                            <div class="color-option" style="background-color: #FFC0CB;" onclick="formatText('hiliteColor', '#FFC0CB')"></div>
                                            <div class="color-option" style="background-color: #FFA500;" onclick="formatText('hiliteColor', '#FFA500')"></div>
                                            <div class="color-option" style="background-color: #ADD8E6;" onclick="formatText('hiliteColor', '#ADD8E6')"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Alignment -->
                                <div class="editor-dropdown">
                                    <button type="button" class="editor-button">Align ‚ñº</button>
                                    <div class="dropdown-content">
                                        <button type="button" onclick="formatText('justifyLeft')">Left</button>
                                        <button type="button" onclick="formatText('justifyCenter')">Center</button>
                                        <button type="button" onclick="formatText('justifyRight')">Right</button>
                                        <button type="button" onclick="formatText('justifyFull')">Justify</button>
                                    </div>
                                </div>

                                <!-- Lists -->
                                <button type="button" class="editor-button" onclick="formatText('insertUnorderedList')" title="Unordered List">‚Ä¢ List</button>
                                <button type="button" class="editor-button" onclick="formatText('insertOrderedList')" title="Ordered List">1. List</button>

                                <!-- Indentation -->
                                <button type="button" class="editor-button" onclick="formatText('indent')" title="Indent">‚Ü≥</button>
                                <button type="button" class="editor-button" onclick="formatText('outdent')" title="Outdent">‚Ü≤</button>

                                <!-- Script -->
                                <button type="button" class="editor-button" onclick="formatText('superscript')" title="Superscript">X¬≤</button>
                                <button type="button" class="editor-button" onclick="formatText('subscript')" title="Subscript">X‚ÇÇ</button>

                                <!-- Media -->
                                <button type="button" class="editor-button" onclick="insertLink()" title="Insert Link">üîó</button>
                                <button type="button" class="editor-button" onclick="insertImage()" title="Insert Image">üñºÔ∏è</button>
                                <button type="button" class="editor-button" onclick="insertVideo()" title="Insert Video">üé¨</button>

                                <!-- Line Tools -->
                                <button type="button" class="editor-button" onclick="formatText('insertHorizontalRule')" title="Horizontal Line">‚Äï</button>

                                <!-- Clean Format -->
                                <button type="button" class="editor-button" onclick="formatText('removeFormat')" title="Remove Formatting">üßπ</button>

                                <!-- Undo/Redo -->
                                <button type="button" class="editor-button" onclick="formatText('undo')" title="Undo">‚Ü∂</button>
                                <button type="button" class="editor-button" onclick="formatText('redo')" title="Redo">‚Ü∑</button>
                            </div>
                            
                            <!-- Content Editable Div for WYSIWYG Editor -->
                            <div id="description" contenteditable="true" class="w-full mt-1"></div>
                            <p class="text-xs text-yellow-400 mt-1">Type your content and use the toolbar above for formatting. What you see is what you get!</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-400">Article Image</label>
                            
                            <!-- Upload Tabs -->
                            <div class="upload-tabs">
                                <div class="upload-tab active" onclick="switchUploadTab('upload')">Upload File</div>
                                <div class="upload-tab" onclick="switchUploadTab('url')">Image URL</div>
                            </div>
                            
                            <!-- Upload File Content -->
                            <div id="upload-file-content" class="upload-content active">
                                <input type="file" id="article-image" accept="image/*" class="w-full mt-1 file:bg-[#00ff00] file:text-black file:border-0 file:py-1 file:px-2 file:mr-4 file:rounded file:cursor-pointer">
                            </div>
                            
                            <!-- Image URL Content -->
                            <div id="upload-url-content" class="upload-content">
                                <input type="url" id="image-url" placeholder="https://example.com/image.jpg" class="w-full mt-1">
                                <button type="button" onclick="previewImage()" class="btn-primary w-full mt-2">Preview Image</button>
                                <div id="image-preview" class="mt-2 hidden">
                                    <img id="preview-img" class="max-w-full h-auto border border-gray-600">
                                    <p class="text-xs text-green-400 mt-1">Preview loaded successfully!</p>
                                </div>
                            </div>
                            
                            <!-- Source Options -->
                            <div class="mt-4 p-3 border border-gray-600 bg-[#222]">
                                <div class="flex items-center space-x-2 mb-2">
                                    <input type="checkbox" id="has-source" class="h-4 w-4 bg-gray-900 border-gray-700 text-green-500 focus:ring-green-500">
                                    <label for="has-source" class="text-sm font-medium text-gray-400">Include External Source</label>
                                </div>
                                <div id="source-url-container" class="hidden mt-2">
                                    <label for="source-url" class="block text-xs text-gray-400 mb-1">Source URL</label>
                                    <input type="url" id="source-url" placeholder="https://example.com/source" class="w-full text-sm">
                                    <p class="text-xs text-gray-500 mt-1">Original article source URL (will appear as "Source" in the article)</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4 mt-4">
                                <input type="checkbox" id="is-new" checked class="h-4 w-4 bg-gray-900 border-gray-700 text-green-500 focus:ring-green-500">
                                <label for="is-new" class="text-sm text-gray-400">Mark as New (is_new: true)</label>
                                <input type="checkbox" id="is-recommended" class="h-4 w-4 bg-gray-900 border-gray-700 text-green-500 focus:ring-green-500">
                                <label for="is-recommended" class="text-sm text-gray-400">Mark as Recommended (is_recommended: true)</label>
                            </div>
                            <p id="upload-status" class="text-sm mt-2 text-yellow-400"></p>
                        </div>

                        <button type="submit" class="btn-success w-full py-3 text-lg font-bold">APPLY ARTICLE</button>
                    </form>

                    <!-- Reset Data Button -->
                    <div class="mt-6 p-4 border border-red-500 bg-[#222]">
                        <h3 class="text-lg font-semibold text-red-400 mb-2">Danger Zone</h3>
                        <button onclick="resetAllData()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded transition duration-150">
                            RESET ALL ARTICLES DATA
                        </button>
                        <p class="text-xs text-gray-400 mt-2">This will delete all articles and restore initial data. Use with caution!</p>
                    </div>
                </div>

                <!-- Right Column: Export Only -->
                <div class="lg:col-span-1 space-y-6">
                    
                    <!-- JSON Export Area -->
                    <div class="p-4 bg-[#222] border border-green-500 space-y-4">
                        <h3 class="text-xl font-bold text-white">Data Export Terminal</h3>
                        <p class="text-sm text-yellow-400">Use this to update the data in your `reinarticle.html` file.</p>
                        <button id="copy-json-button" class="btn-success w-full py-3">
                            COPY ALL ARTICLES JSON
                        </button>
                        <textarea id="json-output" rows="12" readonly class="w-full text-xs bg-black text-[#00ff00] p-2 resize-none" placeholder="JSON output will appear here..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const CLOUDINARY_API_KEY = '417817946171992'; 
        const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_API_KEY}/image/upload`;
        const CLOUDINARY_UPLOAD_PRESET = 'reinforge_unsigned_preset'; 
        const LOCAL_STORAGE_KEY = 'rcmt_articles_data';
        
        // Initial set of articles
        const INITIAL_ARTICLES_DATA = [
          {
            "foto": "https://placehold.co/800x450/4CAF50/ffffff?text=Tricky+Trials+Update",
            "judul": "Exploring Minecraft 1.21 Update: The Tricky Trials",
            "deskripsi": "<h1>Exploring Minecraft 1.21</h1><p>The <strong>1.21 Update</strong> brings many new challenges and exciting blocks. From the trap-filled Trial Chambers to the elusive Breeze mob.</p><h2>Key Features</h2><ul><li>New mobs and enemies</li><li>Updated combat mechanics</li><li>Enhanced building blocks</li></ul><p>Make sure you are equipped with the best gear before exploring!</p>",
            "link": true,
            "link_url": "https://www.minecraft.net/en-us/article/tricky-trials-out-now",
            "slug": "update-1-21-tricky-trials",
            "is_new": true,
            "is_recommended": true
          },
          {
            "foto": "https://static.beebom.com/wp-content/uploads/2025/11/Mounts-of-Mayhem-features-Minecraft.jpg?resize=1024%2C576&quality=75&strip=all",
            "judul": "Minecraft 1.21.11 'Mounts of Mayhem' Release Date Announced",
            "deskripsi": "Over the past couple of months, we have received a bunch of snapshots and previews that have given players small tastes of everything the upcoming update is going to bring. If you didn't have the time to explore these experimental versions, do not worry, as we have got a complete breakdown of all the new Minecraft Mounts of Mayhem features right here.\n\n**All New Features of Minecraft 1.21.11 Mounts of Mayhem**\nThe Mounts of Mayhem update is all about the chaotic encounters and the high-speed combat with new weapons. This drop will completely change how players move and fight in Minecraft due to the introduction of the spear, which specializes in jostling with opponents. In addition to that, here are all the new features you can expect in Minecraft 1.21.11:",
            "link": true,
            "link_url": "https://beebom.com/minecraft-mounts-of-mayhem-release-date",
            "slug": "minecraft-mounts-of-mayhem-release-date",
            "is_new": true,
            "is_recommended": true
          }
        ];

        // --- Utility Functions ---

        const showStatusMessage = (message, type = 'info') => {
            const el = document.getElementById('upload-status');
            el.textContent = message;
            el.className = 'text-sm mt-2 font-medium';
            if (type === 'success') el.classList.add('text-green-500');
            else if (type === 'error') el.classList.add('text-red-500');
            else el.classList.add('text-yellow-400');
        };

        const switchUploadTab = (tab) => {
            document.querySelectorAll('.upload-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.upload-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'upload') {
                document.querySelector('.upload-tab:nth-child(1)').classList.add('active');
                document.getElementById('upload-file-content').classList.add('active');
            } else {
                document.querySelector('.upload-tab:nth-child(2)').classList.add('active');
                document.getElementById('upload-url-content').classList.add('active');
            }
        };

        const previewImage = () => {
            const url = document.getElementById('image-url').value.trim();
            if (!url) {
                showStatusMessage('Please enter an image URL', 'error');
                return;
            }
            
            const previewImg = document.getElementById('preview-img');
            const previewContainer = document.getElementById('image-preview');
            
            previewImg.src = url;
            previewImg.onload = () => {
                previewContainer.classList.remove('hidden');
                showStatusMessage('Image preview loaded successfully!', 'success');
            };
            previewImg.onerror = () => {
                previewContainer.classList.add('hidden');
                showStatusMessage('Failed to load image. Please check the URL.', 'error');
            };
        };

        // --- WYSIWYG Editor Functions ---

        const formatText = (command, value = null) => {
            document.getElementById('description').focus();
            if (value) {
                document.execCommand(command, false, value);
            } else {
                document.execCommand(command, false, null);
            }
        };

        const insertLink = () => {
            const url = prompt('Enter URL:');
            if (url) {
                formatText('createLink', url);
            }
        };

        const insertImage = () => {
            const url = prompt('Enter image URL:');
            if (url) {
                formatText('insertImage', url);
            }
        };

        const insertVideo = () => {
            const url = prompt('Enter video URL (YouTube/Vimeo/etc):');
            if (url) {
                const videoHTML = `<div class="video-container"><iframe src="${url}" width="560" height="315" frameborder="0" allowfullscreen></iframe></div>`;
                formatText('insertHTML', videoHTML);
            }
        };

        // Make editor more user-friendly
        document.addEventListener('DOMContentLoaded', function() {
            const editor = document.getElementById('description');
            
            // Set some basic styles for the editor
            editor.style.minHeight = '400px';
            editor.style.padding = '12px';
            editor.style.border = '1px solid #ccc';
            editor.style.borderRadius = '4px';
            editor.style.backgroundColor = 'white';
            editor.style.color = 'black';
            
            // Add placeholder text
            editor.innerHTML = '<p>Start writing your article here... Use the toolbar above to format your text.</p>';
            
            // Prevent paste of formatted text that might break the editor
            editor.addEventListener('paste', function(e) {
                e.preventDefault();
                const text = (e.originalEvent || e).clipboardData.getData('text/plain');
                document.execCommand('insertText', false, text);
            });
        });

        // --- Article Management ---

        /**
         * FIXED: Get all articles - combine initial data with local articles
         * Now properly merges instead of replacing
         */
        const getAllArticles = () => {
            let localArticles = [];
            try {
                const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (stored) {
                    localArticles = JSON.parse(stored);
                }
            } catch (e) {
                console.error("Error parsing local articles:", e);
                localStorage.removeItem(LOCAL_STORAGE_KEY);
            }
            
            // FIX: Create a map to avoid duplicates by slug
            const allArticlesMap = new Map();
            
            // Add initial articles first
            INITIAL_ARTICLES_DATA.forEach(article => {
                allArticlesMap.set(article.slug, article);
            });
            
            // Add local articles (they will override initial articles if slugs match)
            localArticles.forEach(article => {
                allArticlesMap.set(article.slug, article);
            });
            
            // Convert map back to array and reverse to show newest first
            return Array.from(allArticlesMap.values()).reverse();
        };

        /**
         * FIXED: Update JSON output properly
         */
        const updateJSONOutput = () => {
            const articles = getAllArticles();
            const outputJSON = JSON.stringify(articles, null, 2);
            document.getElementById('json-output').value = outputJSON;
        };

        // --- Main Logic ---

        window.handleLogin = async () => {
            const enteredToken = document.getElementById('access-token').value.trim();
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = 'Checking token...';

            try {
                const response = await fetch('khamu.json');
                if (!response.ok) {
                    throw new Error("khamu.json not found or failed to load.");
                }
                const config = await response.json();
                const expectedToken = config.secret_token.trim();

                if (enteredToken === expectedToken) {
                    localStorage.setItem('rcmt_access', expectedToken);
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('upload-screen').classList.remove('hidden');
                    statusEl.textContent = 'Access granted. Use JSON Export Terminal.';
                    updateJSONOutput(); // Load existing data
                } else {
                    statusEl.textContent = 'Access denied. Incorrect token.';
                }
            } catch (error) {
                console.error("Login Error:", error);
                statusEl.textContent = `Login failed: ${error.message}`;
            }
        };

        const uploadImageToCloudinary = async (file) => {
            showStatusMessage('Uploading image to Cloudinary...', 'info');

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            
            try {
                const response = await fetch(CLOUDINARY_UPLOAD_URL, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Cloudinary upload failed.');
                }

                const result = await response.json();
                showStatusMessage('Image upload complete.', 'success');
                return result.secure_url;
            } catch (error) {
                showStatusMessage(`Image Upload Error: ${error.message}`, 'error');
                throw error; 
            }
        };

        /**
         * FIXED: Save article locally - now APPENDS instead of REPLACING
         */
        const saveArticleLocally = (newArticle) => {
            let localArticles = [];
            try {
                const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (stored) {
                    localArticles = JSON.parse(stored);
                }
            } catch (e) { 
                console.error("Error loading local articles:", e);
                // If there's an error, start with empty array
                localArticles = [];
            }

            // Check for duplicate slug in local articles
            if (localArticles.some(a => a.slug === newArticle.slug)) {
                 showStatusMessage(`Error: Slug "${newArticle.slug}" already exists in your local articles.`, 'error');
                 return false;
            }

            // FIX: Add new article to existing array
            localArticles.push(newArticle);
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(localArticles));
            return true;
        };

        /**
         * FIXED: Form submission - now properly adds to existing data
         */
        document.getElementById('article-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('title').value.trim();
            const slug = document.getElementById('slug').value.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            const description = document.getElementById('description').innerHTML;
            const isNew = document.getElementById('is-new').checked;
            const isRecommended = document.getElementById('is-recommended').checked;
            const hasSource = document.getElementById('has-source').checked;
            const sourceUrl = document.getElementById('source-url').value.trim();
            
            let imageUrl = '';

            const activeTab = document.querySelector('.upload-tab.active').textContent.trim();
            
            if (activeTab === 'Upload File') {
                const imageInput = document.getElementById('article-image');
                const imageFile = imageInput.files[0];

                if (!imageFile) {
                    showStatusMessage('Please select an image file.', 'error');
                    return;
                }

                try {
                    imageUrl = await uploadImageToCloudinary(imageFile);
                } catch (error) {
                    return;
                }
            } else {
                imageUrl = document.getElementById('image-url').value.trim();
                if (!imageUrl) {
                    showStatusMessage('Please enter an image URL.', 'error');
                    return;
                }
            }

            const newArticle = { 
                foto: imageUrl, 
                judul: title, 
                deskripsi: description, 
                link: hasSource && sourceUrl !== "",
                link_url: hasSource ? sourceUrl : "", 
                slug: slug, 
                is_new: isNew,
                is_recommended: isRecommended
            };

            if (saveArticleLocally(newArticle)) {
                // Reset form but keep existing data
                document.getElementById('article-form').reset();
                document.getElementById('description').innerHTML = '<p>Start writing your article here... Use the toolbar above to format your text.</p>';
                document.getElementById('image-preview').classList.add('hidden');
                document.getElementById('source-url-container').classList.add('hidden');
                document.getElementById('has-source').checked = false;
                
                // FIX: Update JSON output with ALL articles (existing + new)
                updateJSONOutput();
                showStatusMessage('Article applied successfully! JSON updated with all articles.', 'success');
            }
        });

        /**
         * Reset all data function
         */
        const resetAllData = () => {
            if (confirm('Are you sure you want to reset ALL articles data? This will delete all your custom articles and restore initial data.')) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                updateJSONOutput();
                showStatusMessage('All articles data has been reset to initial state.', 'success');
            }
        };

        // Toggle source URL container
        document.getElementById('has-source').addEventListener('change', function() {
            const container = document.getElementById('source-url-container');
            if (this.checked) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        });

        // Copy JSON Button handler
        document.getElementById('copy-json-button').addEventListener('click', () => {
            const jsonOutput = document.getElementById('json-output');
            jsonOutput.select();
            
            try {
                document.execCommand('copy');
                document.getElementById('status-message').textContent = 'JSON copied successfully! Now paste it into ARTICLE_DATA_JSON in reinarticle.html';
                document.getElementById('status-message').classList.remove('text-red-400');
                document.getElementById('status-message').classList.add('text-green-400');
            } catch (err) {
                document.getElementById('status-message').textContent = 'Failed to copy. Manually select and copy the text.';
                document.getElementById('status-message').classList.remove('text-green-400');
                document.getElementById('status-message').classList.add('text-red-400');
            }
        });

        window.initApp = () => {
            const storedToken = localStorage.getItem('rcmt_access');
            if (storedToken) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('upload-screen').classList.remove('hidden');
                document.getElementById('status-message').textContent = 'Access Granted. Start generating articles.';
                updateJSONOutput(); // Load existing data on init
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('upload-screen').classList.add('hidden');
                document.getElementById('status-message').textContent = 'Awaiting token entry.';
            }
        };
    </script>
</body>
</html>
